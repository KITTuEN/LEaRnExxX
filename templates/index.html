{% extends "base.html" %}

{% block title %}Chatbot - Learnex{% endblock %}

{% block content %}
<div class="container py-4 h-100">
    <div class="row h-100">
        <!-- Chat Area -->
        <div class="col-lg-9 col-md-8 d-flex flex-column h-100">
            <div class="card flex-grow-1 shadow-sm mb-3">
                <div class="card-header bg-transparent border-bottom d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 text-white">Gemini Chatbot</h5>
                    <span class="badge bg-primary">AI Powered</span>
                </div>
                <div class="card-body p-0 position-relative">
                    <div id="chat" class="chat-box p-3" style="height: 500px; overflow-y: auto;">
                        <!-- Messages will appear here -->
                        <div class="text-center text-muted mt-5">
                            <p>Start a conversation with Gemini AI!</p>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-transparent border-top p-3">
                    <div class="input-group">
                        <input type="text" id="message" class="form-control" placeholder="Type your question..."
                            autocomplete="off">
                        <button class="btn btn-primary" type="button" onclick="send()">
                            Send <i class="bi bi-send-fill ms-1"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Sidebar -->
        <div class="col-lg-3 col-md-4 d-none d-md-block h-100">
            <div class="card h-100 shadow-sm">
                <div class="card-header bg-transparent border-bottom">
                    <h6 class="mb-0 text-white">Recent Chats</h6>
                </div>
                <div class="card-body p-0">
                    <div id="history-container" class="list-group list-group-flush"
                        style="height: 500px; overflow-y: auto;">
                        <!-- History items will appear here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const chat = document.getElementById('chat');
    const historyContainer = document.getElementById('history-container');
    let recentChats = [];
    let activeHistory = null;

    function addMsg(sender, htmlContent) {
        // Remove initial placeholder if present
        if (chat.querySelector('.text-center')) {
            chat.innerHTML = '';
        }

        let div = document.createElement('div');
        div.className = 'chat-message ' + sender + ' mb-3 p-3 rounded-3';

        if (sender === 'user') {
            div.classList.add('bg-primary', 'text-white', 'ms-auto');
            div.style.maxWidth = '80%';
            div.textContent = htmlContent;
        } else {
            div.classList.add('bg-dark', 'border', 'border-secondary', 'text-light', 'me-auto');
            div.style.maxWidth = '80%';
            div.innerHTML = htmlContent;
        }

        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
    }

    async function send() {
        let msgInput = document.getElementById('message');
        let msg = msgInput.value.trim();
        if (!msg) return;

        addMsg('user', msg);
        msgInput.value = '';

        // Show loading indicator
        let loadingDiv = document.createElement('div');
        loadingDiv.id = 'loading-msg';
        loadingDiv.className = 'chat-message bot mb-3 p-3 rounded-3 bg-dark border border-secondary text-light me-auto';
        loadingDiv.innerHTML = '<div class="spinner-border spinner-border-sm text-light" role="status"><span class="visually-hidden">Loading...</span></div> Thinking...';
        chat.appendChild(loadingDiv);
        chat.scrollTop = chat.scrollHeight;

        try {
            let payload = msg;
            if (activeHistory) {
                const contextText = buildContextFromHistory(activeHistory);
                payload = contextText + "\n\nNew question: " + msg;
            }
            let resp = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: payload })
            });
            let data = await resp.json();

            // Remove loading indicator
            const loader = document.getElementById('loading-msg');
            if (loader) loader.remove();

            if (data.response) {
                addMsg('bot', data.response);
            } else {
                addMsg('bot', "Error: " + (data.error || "No response"));
            }
        } catch (err) {
            const loader = document.getElementById('loading-msg');
            if (loader) loader.remove();
            addMsg('bot', "Error: " + err.message);
        }
    }

    document.getElementById('message').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') send();
    });

    function buildContextFromHistory(item) {
        const tmp = document.createElement('div');
        tmp.innerHTML = item.bot_response || '';
        const cleanBot = tmp.textContent || tmp.innerText || '';
        return (
            "Previous chat context:\\n" +
            "User: " + (item.user_message || '') + "\\n" +
            "Assistant: " + cleanBot.trim()
        );
    }

    async function loadHistory() {
        try {
            const resp = await fetch('/api/user-chats?limit=30');
            if (!resp.ok) {
                historyContainer.innerHTML = '<div class="p-3 text-muted small">Unable to load history.</div>';
                return;
            }
            const data = await resp.json();
            if (!data.conversations || !data.conversations.length) {
                historyContainer.innerHTML = '<div class="p-3 text-muted small">No chats yet.</div>';
                return;
            }
            recentChats = data.conversations;
            historyContainer.innerHTML = '';
            recentChats.forEach(conv => {
                const date = conv.timestamp ? new Date(conv.timestamp) : null;
                const timeLabel = date ? date.toLocaleString() : '';
                const fullMsg = (conv.user_message || '').trim();
                const title = fullMsg.length > 40 ? fullMsg.slice(0, 40) + 'â€¦' : fullMsg || '(no message)';
                const id = (conv._id || timeLabel.replace(/[^0-9]/g, '')).toString();

                const item = document.createElement('a');
                item.href = '#';
                item.className = 'list-group-item list-group-item-action bg-transparent border-secondary text-light';
                item.dataset.id = id;
                item.onclick = (e) => { e.preventDefault(); selectHistory(id); };

                item.innerHTML = `
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1 text-truncate" style="max-width: 100%;">${title}</h6>
                    </div>
                    <small class="text-muted">${timeLabel}</small>
                `;
                historyContainer.appendChild(item);
            });
        } catch (e) {
            historyContainer.innerHTML = '<div class="p-3 text-muted small">Unable to load history.</div>';
        }
    }

    function selectHistory(id) {
        const conv = recentChats.find(c => (c._id || '').toString() === id);
        if (!conv) return;
        activeHistory = conv;

        document.querySelectorAll('.list-group-item').forEach(el => {
            el.classList.remove('active');
        });
        const selected = document.querySelector('.list-group-item[data-id=\"' + id + '\"]');
        if (selected) {
            selected.classList.add('active');
        }

        chat.innerHTML = '';
        if (conv.user_message) addMsg('user', conv.user_message);
        if (conv.bot_response) addMsg('bot', conv.bot_response);
    }

    window.addEventListener('DOMContentLoaded', loadHistory);
</script>
{% endblock %}